<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Battle Check</title>
    <link rel="stylesheet" href="css/hackCheck.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://developer.relayr.io/relayr-browser-sdk.min.js"></script>
    <script>

        var soundLevels = {
            COMFORT: {value: 0, name: "comfort", message: "Noise in comfort zone", color: "green", soundScoreLevel: 0,img:'img/comfort.jpg' },
            NOISILY: {value: 1, name: "noisily", message: "Noisily", color: "yellow", soundScoreLevel: 80,img:'img/noisily.jpg' },
            METRO: {value: 2, name: "moscow metro", message: "Relax and read book", color: "red", soundScoreLevel: 240, img:'img/metro.jpg' },
            ORCS_CAMP: {value: 2, name: "orc's camp", message: "Please leave orc's camp", color: "red", soundScoreLevel: 440,img:'img/Orcs.jpg'  },
            BATLEHACK_ROAR: {value: 3, name: "BATTLEHACK ROAR", message: "Yes, baby. It's BattleHack 2014!!!11", color: "blue", soundScoreLevel: 700, img:'img/battlehack.jpg' }
        };

        function soundScoreChanged(soundScore) {
            $('#noiseLevel').text('Noise score: ' + soundScore);
        }

        function soundLevelChanged(soundLevel) {
            $('#achievement').text('Noise level: ' + soundLevel.name + '. ' + soundLevel.message);
            $('#image').css('background-image', 'url('+soundLevel.img+')');
        }

        var soundChecker = (function (onScoreChangedCallback) {

            var _currSoundLevelScores = 0;
            var _lastSoundLevelChangeTs = 0;
            var _onScoreChangedCallback;
            var _onLevelChangeCallback;
            return {
                setLevelChangedCallback: function (onLevelChangedCallback) {
                    _onLevelChangeCallback = onLevelChangedCallback;
                },
                setScoreChangedCallback: function (onScoreChangedCallback) {
                    _onScoreChangedCallback = onScoreChangedCallback;
                },

                check: function (soundLevelData) {
                    if (soundLevelData.snd_level > _currSoundLevelScores) {
                        _currSoundLevelScores = soundLevelData.snd_level;
                        _lastSoundLevelChangeTs = soundLevelData.ts;
                        if (_currSoundLevelScores > soundLevels.BATLEHACK_ROAR.soundScoreLevel) {
                            _onLevelChangeCallback(soundLevels.BATLEHACK_ROAR);
                        } else if (_currSoundLevelScores > soundLevels.ORCS_CAMP.soundScoreLevel) {
                            _onLevelChangeCallback(soundLevels.ORCS_CAMP);
                        } else if (_currSoundLevelScores > soundLevels.METRO.soundScoreLevel) {
                            _onLevelChangeCallback(soundLevels.METRO);
                        } else if (_currSoundLevelScores > soundLevels.NOISILY.soundScoreLevel) {
                            _onLevelChangeCallback(soundLevels.NOISILY);
                        } else {
                            _onLevelChangeCallback(soundLevels.COMFORT);
                        }
                    } else {
                        if ((soundLevelData.ts - _lastSoundLevelChangeTs)/1000>10){
                            _currSoundLevelScores = 0;
                            _lastSoundLevelChangeTs = soundLevelData.ts;
                        };
                    };

                    _onScoreChangedCallback(soundLevelData.snd_level);
                }
            };
        })();

        soundChecker.setLevelChangedCallback(soundLevelChanged);
        soundChecker.setScoreChangedCallback(soundScoreChanged);

        $(document).ready(function () {

            var myAppId = '6d639b4d-7e4d-4c34-a7d2-f410d119d193';
            var myTokenId = 'L90dUBR0cmr4BsvemQUPCGn-Q8kzMiZC'
            var myDeviceId = '077cbc8c-eece-4b6e-9bd6-fcb74ce13a27';


            var relayr = RELAYR.init({
                appId: myAppId
            });
            console.log("inited")
            relayr.devices().getDeviceData({
                token: myTokenId,
                deviceId: myDeviceId,
                incomingData: function (data) {
                    console.log("data from device", data)
                    soundChecker.check(data);
                }
            });
        });

    </script>
</head>
<body>
<table>
    <tr>
        <td>
            <span class="mega-header" id="noiseLevel"></span>
        </td>
    </tr>
    <tr>
        <td>
            <div>
                <div id="image" class="imageDiv"></div>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <span class="mega-header" id="achievement"></span>
        </td>
    </tr>
</table>
</body>
</html>