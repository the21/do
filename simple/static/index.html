<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title></title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>

<div class="container-fluid main">
    <div class="col-md-8 content">
        <form action="#" class="submit-taks-form">
            <h1>Хочу не есть после</h1>
            <div class="form-group form-param">
                <input id="stopTime" type="time" size="30">
            </div>
            <div>
                <button id="turn_on" type="submit" onclick="return start_track();" class="btn btn-primary btn-lg submit-task-btn">Да!</button>
            </div>
            <div>
            <button id="turn_off" type="submit" onclick="return stop_track();" class="invisible btn btn-primary btn-lg submit-task-btn">Остановите эту пытку!</button>
            </div>
            <h1 id="myRecord"></h1>
        </form>
    </div>
</div>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap&#45;theme.min.css"> -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
</body>
</html>

<script type="text/javascript">
    function switch_button(isOn) {
        if (isOn) {
            $("#turn_on").removeClass("invisible");
            $("#turn_off").addClass("invisible");
        } else {
            $("#turn_on").addClass("invisible");
            $("#turn_off").removeClass("invisible");
        }
    }
    function start_track() {
        $.getJSON("/api/start", {}, function(reply) {
                switch_button(false);
            });
    }
    function stop_track() {
        $.getJSON("/api/stop", {}, function(reply) {
                switch_button(true);
            });
    }

    function dateDiff(date1, date2) {
        date1 = new Date(date1);
        date2 = new Date(date2);

        var milliseconds = date2.getMilliseconds() - date1.getMilliseconds();

        if (milliseconds < 0) {
            milliseconds += 1000;
            date2.setSeconds(date2.getSeconds() - 1);
        }

        var seconds = date2.getSeconds() - date1.getSeconds();

        if (seconds < 0) {
            seconds += 60;
            date2.setMinutes(date2.getMinutes() - 1);
        }

        var minutes = date2.getMinutes() - date1.getMinutes();

        if (minutes < 0) {
            minutes += 60;
            date2.setHours(date2.getHours() - 1);
        }

        var hours = date2.getHours() - date1.getHours();

        if (hours < 0) {
            hours += 24;
            date2.setDate(date2.getDate() - 1);
        }

        var days = date2.getDate() - date1.getDate();

        if (days < 0) {
            days += new Date(date2.getFullYear(), date2.getMonth() - 1, 0).getDate() + 1;
            date2.setMonth(date2.getMonth() - 1);
        }

        var months = date2.getMonth() - date1.getMonth();

        if (months < 0) {
            months += 12;
            date2.setFullYear(date2.getFullYear() - 1);
        }

        var years = date2.getFullYear() - date1.getFullYear();

        return [ years, months, days, hours, minutes, seconds, milliseconds ];
    };

    var dataRepository = function (listenerId) {

        var _listenerId = listenerId;

        return {
            getStopTimeInfo: function () {
                var requestResult = {
                    "count": 2,
                    "next": null,
                    "previous": null,
                    "results": [
                        {
                            "id": 1,
                            "url": "http://127.0.0.1:8000/v0/listeners/1/",
                            "title": "test temperature always",
                            "d_type": 1,
                            "save_all_checks": false,
                            "min_value": 0,
                            "max_value": 0,
                            "pub_date": "2014-10-25T17:27:01.039",
                            "min_time_value": null,
                            "max_time_value": null,
                            "creator": "http://127.0.0.1:8000/v0/users/1/"
                        },
                        {
                            "id": 2,
                            "url": "http://127.0.0.1:8000/v0/listeners/2/",
                            "title": "light 20-24 test",
                            "d_type": 3,
                            "save_all_checks": false,
                            "min_value": 0,
                            "max_value": 0,
                            "pub_date": "2014-10-21T17:33:10.655",
                            "min_time_value": "20:00:00",
                            "max_time_value": "23:59:00",
                            "creator": "http://127.0.0.1:8000/v0/users/1/"
                        }
                    ]
                };

                var index;
                var listener;
                for (index = 0; index < requestResult.results.length; ++index) {
                    if (requestResult.results[index].id == _listenerId) {
                        listener = requestResult.results[index];
                        break;
                    }
                }
                return {stopTime:listener.min_time_value, eventStartDate:listener.pub_date};
            },

            getOverbearDaysCount: function (eventStartDate) {
                var requestResult = {
                    "count": 163,
                    "next": "http://127.0.0.1:8000/v0/events/?page=2&format=json",
                    "previous": null,
                    "results": [
                        {
                            "listenerId": 2,
                            "url": "http://127.0.0.1:8000/v0/events/1/",
                            "listener": "http://127.0.0.1:8000/v0/listeners/1/",
                            "data": "http://127.0.0.1:8000/v0/entries/1224/",
                            "pub_date": "2014-10-20T22:36:39.019"
                        },
                        {
                            "listenerId": 2,
                            "url": "http://127.0.0.1:8000/v0/events/2/",
                            "listener": "http://127.0.0.1:8000/v0/listeners/1/",
                            "data": "http://127.0.0.1:8000/v0/entries/1227/",
                            "pub_date": "2014-10-21T22:36:40.517"
                        },
                        {
                            "listenerId": 2,
                            "url": "http://127.0.0.1:8000/v0/events/3/",
                            "listener": "http://127.0.0.1:8000/v0/listeners/1/",
                            "data": "http://127.0.0.1:8000/v0/entries/1233/",
                            "pub_date": "2014-10-22T22:36:49.685"
                        },
                        {
                            "listenerId": 2,
                            "url": "http://127.0.0.1:8000/v0/events/4/",
                            "listener": "http://127.0.0.1:8000/v0/listeners/1/",
                            "data": "http://127.0.0.1:8000/v0/entries/1235/",
                            "pub_date": "2014-10-23T22:36:50.747"
                        },
                        {
                            "listenerId": 2,
                            "url": "http://127.0.0.1:8000/v0/events/5/",
                            "listener": "http://127.0.0.1:8000/v0/listeners/1/",
                            "data": "http://127.0.0.1:8000/v0/entries/1237/",
                            "pub_date": "2014-10-24T22:36:51.037"
                        }
                    ]
                };

                var index;
                var maxdate = eventStartDate;
                for (index = 0; index < requestResult.results.length; ++index) {
                    if (!maxdate || requestResult.results[index].pub_date > maxdate) {
                        maxdate = requestResult.results[index].pub_date;
                    }
                }

                return dateDiff(maxdate,new Date())[2];
            }


        }
    }

    var repository = dataRepository(2);
    var stopTimeInfo = repository.getStopTimeInfo();
    $('#stopTime').val(stopTimeInfo.stopTime);
    var overbearDaysCount = repository.getOverbearDaysCount(stopTimeInfo.eventStartDate);
    if (overbearDaysCount > 0) {
        var recordText = "I do not eat after " + stopTimeInfo.stopTime + " whole " + overbearDaysCount + " days";
        $('#myRecord').text(recordText);
    }

</script>
